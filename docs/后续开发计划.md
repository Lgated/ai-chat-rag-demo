# AI èŠå¤©å®¤é¡¹ç›® - åç»­å¼€å‘è®¡åˆ’

## ğŸ“‹ é¡¹ç›®å½“å‰çŠ¶æ€è¯„ä¼°

### âœ… å·²å®Œæˆéƒ¨åˆ†

1. **åŸºç¡€æ¡†æ¶**
   - Spring Boot 3.3.0 + WebFlux
   - PostgreSQL + JPA æ•°æ®æŒä¹…åŒ–
   - Lombok ä»£ç ç®€åŒ–

2. **æ•°æ®å±‚**
   - âœ… `Conversation` å®ä½“ï¼ˆä¼šè¯è¡¨ï¼‰
   - âœ… `Message` å®ä½“ï¼ˆæ¶ˆæ¯è¡¨ï¼‰
   - âœ… Repository å±‚ï¼ˆConversationRepository, MessageRepositoryï¼‰
   - âœ… æ‡’åŠ è½½é—®é¢˜å·²è§£å†³ï¼ˆ@JsonIgnoreï¼‰

3. **ä¸šåŠ¡å±‚**
   - âœ… Service æ¥å£ + å®ç°ç±»ï¼ˆChatService, ChatServiceImplï¼‰
   - âœ… åŸºç¡€ CRUD æ“ä½œï¼ˆåˆ›å»ºä¼šè¯ã€æŸ¥è¯¢æ¶ˆæ¯ã€æ·»åŠ æ¶ˆæ¯ï¼‰

4. **æ¥å£å±‚**
   - âœ… Controllerï¼ˆChatControllerï¼‰
   - âœ… ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆResult<T>ï¼‰
   - âœ… RESTful API è®¾è®¡

### âŒ å¾…å®Œæˆéƒ¨åˆ†

1. **AI èƒ½åŠ›**
   - â³ Spring AI é›†æˆï¼ˆå¤§æ¨¡å‹è°ƒç”¨ï¼‰
   - â³ SSE æµå¼è¾“å‡º
   - â³ Embedding å‘é‡åŒ–
   - â³ RAG çŸ¥è¯†åº“æ£€ç´¢
   - â³ Agent/FunctionCall

2. **å‰ç«¯ç•Œé¢**
   - â³ React èŠå¤©ç•Œé¢
   - â³ ä¼šè¯åˆ—è¡¨
   - â³ æ¶ˆæ¯å±•ç¤º
   - â³ æµå¼æ¶ˆæ¯æ¥æ”¶

3. **é«˜çº§åŠŸèƒ½**
   - â³ Neo4j çŸ¥è¯†å›¾è°±
   - â³ å›¾ç‰‡ç”Ÿæˆ/ç†è§£
   - â³ å‘é‡æ•°æ®åº“é›†æˆ

---

## ğŸ¯ å¼€å‘è·¯çº¿å›¾ï¼ˆå»ºè®®é¡ºåºï¼‰

è€ƒè™‘åˆ°ä¸€ä¸ªæœˆçš„æ—¶é—´é™åˆ¶å’Œé¡¹ç›®æ¼”ç¤ºéœ€æ±‚ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå¼€å‘ï¼š

```
é˜¶æ®µ1: Spring AI é›†æˆ + åŸºç¡€å¯¹è¯åŠŸèƒ½ï¼ˆ3-4å¤©ï¼‰
    â†“
é˜¶æ®µ2: å‰ç«¯ React åŸºç¡€ç•Œé¢ï¼ˆ3-4å¤©ï¼‰
    â†“
é˜¶æ®µ3: SSE æµå¼è¾“å‡ºï¼ˆ2-3å¤©ï¼‰
    â†“
é˜¶æ®µ4: RAG + å‘é‡æ•°æ®åº“ï¼ˆ5-7å¤©ï¼‰
    â†“
é˜¶æ®µ5: Agent/FunctionCallï¼ˆå¯é€‰ï¼Œ3-5å¤©ï¼‰
```

**ä¸ºä»€ä¹ˆä¸å…ˆåšå‰ç«¯ï¼Ÿ**
- å…ˆåšåç«¯ AI åŠŸèƒ½ï¼Œç¡®ä¿æ ¸å¿ƒèƒ½åŠ›å¯ç”¨
- å‰ç«¯å¯ä»¥å…ˆç”¨ Postman æµ‹è¯•æ¥å£ï¼ŒéªŒè¯é€»è¾‘
- åç«¯å®Œæˆåå†åšå‰ç«¯ï¼Œä¸€æ¬¡æ€§å¯¹æ¥å®Œæ•´çš„æ¥å£

---

## ğŸ“… è¯¦ç»†å¼€å‘è®¡åˆ’

### é˜¶æ®µ 1ï¼šSpring AI é›†æˆ + åŸºç¡€å¯¹è¯åŠŸèƒ½ï¼ˆä¼˜å…ˆï¼‰

**ç›®æ ‡**ï¼šè®©åç«¯èƒ½å¤Ÿè°ƒç”¨å¤§æ¨¡å‹ï¼Œå®ç°åŸºæœ¬çš„é—®ç­”åŠŸèƒ½

**æ—¶é—´ä¼°ç®—**ï¼š3-4 å¤©

#### æ­¥éª¤ 1.1ï¼šæ·»åŠ  Spring AI ä¾èµ–

**ä¿®æ”¹ `pom.xml`**

```xml
<dependencies>
    <!-- ... ç°æœ‰ä¾èµ– ... -->

    <!-- Spring AI OpenAI (æ”¯æŒå¤šç§æ¨¡å‹ä¾›åº”å•†) -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
        <version>1.0.0-M4</version>
    </dependency>

    <!-- å¦‚æœéœ€è¦ä½¿ç”¨ DashScopeï¼ˆé˜¿é‡Œé€šä¹‰åƒé—®ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª -->
    <!-- 
    <dependency>
        <groupId>com.alibaba.cloud.ai</groupId>
        <artifactId>spring-cloud-starter-alibaba-ai</artifactId>
        <version>2023.0.1.0</version>
    </dependency>
    -->
</dependencies>
```

**æ³¨æ„**ï¼š
- Spring AI ç‰ˆæœ¬å¯èƒ½è¾ƒæ–°ï¼Œå¦‚æœæ‰¾ä¸åˆ°ä¾èµ–ï¼Œå¯ä»¥å…ˆä½¿ç”¨ OpenAI çš„å…¼å®¹æ¥å£
- æˆ–è€…ç›´æ¥ä½¿ç”¨ DashScope/OpenAI çš„å®˜æ–¹ Java SDKï¼Œä¸ç”¨ Spring AI

#### æ­¥éª¤ 1.2ï¼šé…ç½® API Key

**ä¿®æ”¹ `application.yml`**

```yaml
server:
  port: 8080

spring:
  application:
    name: test-easyjava

  datasource:
    url: jdbc:postgresql://localhost:5432/ai_chat
    username: postgres
    password: 123456
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect

  # Spring AI é…ç½®ï¼ˆä»¥ OpenAI ä¸ºä¾‹ï¼‰
  ai:
    openai:
      api-key: ${OPENAI_API_KEY:your-api-key-here}  # ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæˆ–ç›´æ¥å†™æ­»ï¼ˆä¸æ¨èï¼‰
      chat:
        options:
          model: gpt-3.5-turbo  # æˆ– gpt-4
          temperature: 0.7
```

**æˆ–è€…ä½¿ç”¨ DashScopeï¼ˆé˜¿é‡Œé€šä¹‰åƒé—®ï¼‰é…ç½®**ï¼š

```yaml
spring:
  ai:
    dashscope:
      api-key: ${DASHSCOPE_API_KEY:your-dashscope-key}
      chat:
        options:
          model: qwen-turbo  # æˆ– qwen-plus
```

#### æ­¥éª¤ 1.3ï¼šåˆ›å»º AI Service

**åˆ›å»º `src/main/java/com/example/demo/service/AiService.java`**

```java
package com.example.demo.service;

public interface AiService {
    
    /**
     * è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå›ç­”ï¼ˆéæµå¼ï¼‰
     * @param userMessage ç”¨æˆ·æ¶ˆæ¯
     * @param conversationHistory å†å²æ¶ˆæ¯ï¼ˆç”¨äºä¸Šä¸‹æ–‡ï¼‰
     * @return AI ç”Ÿæˆçš„å›ç­”
     */
    String generateResponse(String userMessage, String conversationHistory);
}
```

**åˆ›å»º `src/main/java/com/example/demo/service/impl/AiServiceImpl.java`**

```java
package com.example.demo.service.impl;

import com.example.demo.service.AiService;
import org.springframework.ai.chat.ChatClient;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
public class AiServiceImpl implements AiService {

    private final ChatClient chatClient;

    public AiServiceImpl(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @Override
    public String generateResponse(String userMessage, String conversationHistory) {
        // æ„å»º Prompt
        StringBuilder promptBuilder = new StringBuilder();
        
        // å¦‚æœæœ‰å†å²ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ è¿›å»
        if (conversationHistory != null && !conversationHistory.isEmpty()) {
            promptBuilder.append("ä»¥ä¸‹æ˜¯å¯¹è¯å†å²ï¼š\n").append(conversationHistory).append("\n\n");
        }
        
        promptBuilder.append("è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š\n").append(userMessage);
        
        // åˆ›å»º Prompt å¯¹è±¡
        Prompt prompt = new Prompt( --new UserMessage(promptBuilder.toString()));
        
        // è°ƒç”¨å¤§æ¨¡å‹
        String response = chatClient.call(prompt).getResult().getOutput().getContent();
        
        return response;
    }
}
```

#### æ­¥éª¤ 1.4ï¼šä¿®æ”¹ ChatServiceï¼Œé›†æˆ AI

**ä¿®æ”¹ `ChatServiceImpl.java`**

```java
package com.example.demo.service.Impl;

import com.example.demo.domain.Conversation;
import com.example.demo.domain.Message;
import com.example.demo.repository.ConversationRepository;
import com.example.demo.repository.MessageRepository;
import com.example.demo.service.AiService;
import com.example.demo.service.ChatService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class ChatServiceImpl implements ChatService {

    private final ConversationRepository conversationRepository;
    private final MessageRepository messageRepository;
    private final AiService aiService;  // æ–°å¢

    public ChatServiceImpl(ConversationRepository conversationRepository,
                           MessageRepository messageRepository,
                           AiService aiService) {  // æ–°å¢å‚æ•°
        this.conversationRepository = conversationRepository;
        this.messageRepository = messageRepository;
        this.aiService = aiService;
    }

    // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ ...

    @Override
    @Transactional
    public Message addMessage(Long conversationId, String role, String content) {
        Conversation conversation = conversationRepository.findById(conversationId)
                .orElseThrow(() -> new IllegalArgumentException("ä¼šè¯ä¸å­˜åœ¨" + conversationId));

        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        Message userMessage = new Message();
        userMessage.setConversation(conversation);
        userMessage.setRole(role);
        userMessage.setContent(content);
        messageRepository.save(userMessage);
        

        // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œè°ƒç”¨ AI ç”Ÿæˆå›ç­”
        if ("user".equals(role)) {
            // è·å–å†å²æ¶ˆæ¯ï¼ˆç”¨äºä¸Šä¸‹æ–‡ï¼‰
            List<Message> historyMessages = messageRepository
                    .findByConversationIdOrderByCreatedAtAsc(conversationId);
            
            // æ„å»ºå†å²æ¶ˆæ¯æ–‡æœ¬ï¼ˆåªå–æœ€è¿‘ 10 æ¡ï¼Œé¿å… token è¿‡å¤šï¼‰
            String historyText = historyMessages.stream()
                    .limit(10)
                    .map(msg -> msg.getRole() + ": " + msg.getContent())
                    .collect(Collectors.joining("\n"));

            // è°ƒç”¨ AI ç”Ÿæˆå›ç­”
            String aiResponse = aiService.generateResponse(content, historyText);

            // ä¿å­˜ AI å›ç­”
            Message assistantMessage = new Message();
            assistantMessage.setConversation(conversation);
            assistantMessage.setRole("assistant");
            assistantMessage.setContent(aiResponse);
            messageRepository.save(assistantMessage);

            return assistantMessage;  // è¿”å› AI çš„å›ç­”
        }

        return userMessage;
    }
}
```

#### æ­¥éª¤ 1.5ï¼šæµ‹è¯•æ¥å£

**ä½¿ç”¨ Postman æµ‹è¯•**ï¼š

```bash
# 1. åˆ›å»ºä¼šè¯
POST http://localhost:8080/api/chat/conversations
Body: { "title": "AIå¯¹è¯æµ‹è¯•" }

# 2. å‘é€æ¶ˆæ¯ï¼ˆä¼šè‡ªåŠ¨è°ƒç”¨ AIï¼‰
POST http://localhost:8080/api/chat/conversations/1/messages
Body: { "role": "user", "content": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±" }

# 3. æŸ¥çœ‹æ‰€æœ‰æ¶ˆæ¯
GET http://localhost:8080/api/chat/conversations/1/messages
```

---

### é˜¶æ®µ 2ï¼šå‰ç«¯ React åŸºç¡€ç•Œé¢

**ç›®æ ‡**ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„èŠå¤©ç•Œé¢ï¼Œèƒ½å¤Ÿå±•ç¤ºä¼šè¯åˆ—è¡¨ã€å‘é€æ¶ˆæ¯ã€æ˜¾ç¤º AI å›ç­”

**æ—¶é—´ä¼°ç®—**ï¼š3-4 å¤©

#### æ­¥éª¤ 2.1ï¼šåˆ›å»º React é¡¹ç›®

**åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ**ï¼š

```bash
# ä½¿ç”¨ Vite åˆ›å»º React + TypeScript é¡¹ç›®ï¼ˆæ¨èï¼Œé€Ÿåº¦å¿«ï¼‰
npm create vite@latest frontend -- --template react-ts

# æˆ–ä½¿ç”¨ create-react-appï¼ˆè¾ƒæ…¢ä½†ç¨³å®šï¼‰
npx create-react-app frontend --template typescript
```

**é¡¹ç›®ç»“æ„**ï¼š

```
test_easyJava/
â”œâ”€â”€ backend/          # åç«¯ï¼ˆå½“å‰ä»£ç ï¼‰
â””â”€â”€ frontend/         # å‰ç«¯ï¼ˆæ–°åˆ›å»ºï¼‰
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ pages/
    â”‚   â”œâ”€â”€ services/    # API è°ƒç”¨
    â”‚   â”œâ”€â”€ App.tsx
    â”‚   â””â”€â”€ main.tsx
    â”œâ”€â”€ package.json
    â””â”€â”€ vite.config.ts
```

#### æ­¥éª¤ 2.2ï¼šå®‰è£…å¿…è¦ä¾èµ–

**åœ¨ `frontend/` ç›®å½•ä¸‹æ‰§è¡Œ**ï¼š

```bash
cd frontend
npm install axios          # HTTP è¯·æ±‚
npm install @tanstack/react-query  # æ•°æ®ç®¡ç†ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
```

#### æ­¥éª¤ 2.3ï¼šåˆ›å»º API æœåŠ¡

**åˆ›å»º `frontend/src/services/api.ts`**

```typescript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:8080/api/chat',
  headers: {
    'Content-Type': 'application/json',
  },
});

// ç»Ÿä¸€å“åº”ç±»å‹
export interface ApiResponse<T> {
  code: number;
  message: string;
  data: T;
  timestamp: number;
}

// ä¼šè¯ç±»å‹
export interface Conversation {
  id: number;
  title: string;
  createdAt: string;
}

// æ¶ˆæ¯ç±»å‹
export interface Message {
  id: number;
  role: 'user' | 'assistant';
  content: string;
  createdAt: string;
}

// API æ–¹æ³•
export const chatApi = {
  // è·å–æ‰€æœ‰ä¼šè¯
  getConversations: (): Promise<ApiResponse<Conversation[]>> => {
    return api.get('/conversations').then(res => res.data);
  },

  // åˆ›å»ºä¼šè¯
  createConversation: (title: string): Promise<ApiResponse<Conversation>> => {
    return api.post('/conversations', { title }).then(res => res.data);
  },

  // è·å–ä¼šè¯æ¶ˆæ¯
  getMessages: (conversationId: number): Promise<ApiResponse<Message[]>> => {
    return api.get(`/conversations/${conversationId}/messages`).then(res => res.data);
  },

  // å‘é€æ¶ˆæ¯
  sendMessage: (
    conversationId: number,
    content: string
  ): Promise<ApiResponse<Message>> => {
    return api
      .post(`/conversations/${conversationId}/messages`, {
        role: 'user',
        content,
      })
      .then(res => res.data);
  },
};
```

#### æ­¥éª¤ 2.4ï¼šåˆ›å»ºèŠå¤©é¡µé¢ç»„ä»¶

**åˆ›å»º `frontend/src/pages/ChatPage.tsx`**

```typescript
import { useState, useEffect } from 'react';
import { chatApi, Conversation, Message } from '../services/api';
import './ChatPage.css';

const ChatPage = () => {
  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [currentConversationId, setCurrentConversationId] = useState<number | null>(null);
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState('');
  const [loading, setLoading] = useState(false);

  // åŠ è½½ä¼šè¯åˆ—è¡¨
  useEffect(() => {
    chatApi.getConversations().then((res) => {
      if (res.code === 200) {
        setConversations(res.data);
        // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªä¼šè¯
        if (res.data.length > 0) {
          setCurrentConversationId(res.data[0].id);
        }
      }
    });
  }, []);

  // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
  useEffect(() => {
    if (currentConversationId) {
      chatApi.getMessages(currentConversationId).then((res) => {
        if (res.code === 200) {
          setMessages(res.data);
        }
      });
    }
  }, [currentConversationId]);

  // å‘é€æ¶ˆæ¯
  const handleSend = async () => {
    if (!inputText.trim() || !currentConversationId || loading) return;

    const userMessage = inputText.trim();
    setInputText('');
    setLoading(true);

    try {
      // å‘é€æ¶ˆæ¯ï¼ˆåç«¯ä¼šè‡ªåŠ¨è°ƒç”¨ AI ç”Ÿæˆå›ç­”ï¼‰
      const res = await chatApi.sendMessage(currentConversationId, userMessage);
      
      if (res.code === 200) {
        // é‡æ–°åŠ è½½æ¶ˆæ¯åˆ—è¡¨
        const messagesRes = await chatApi.getMessages(currentConversationId);
        if (messagesRes.code === 200) {
          setMessages(messagesRes.data);
        }
      }
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
      alert('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  // åˆ›å»ºæ–°ä¼šè¯
  const handleNewConversation = async () => {
    const title = prompt('è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜:', 'æ–°ä¼šè¯');
    if (!title) return;

    const res = await chatApi.createConversation(title);
    if (res.code === 200) {
      setConversations([...conversations, res.data]);
      setCurrentConversationId(res.data.id);
    }
  };

  return (
    <div className="chat-container">
      {/* å·¦ä¾§ï¼šä¼šè¯åˆ—è¡¨ */}
      <div className="sidebar">
        <button className="new-chat-btn" onClick={handleNewConversation}>
          + æ–°ä¼šè¯
        </button>
        <div className="conversation-list">
          {conversations.map((conv) => (
            <div
              key={conv.id}
              className={`conversation-item ${
                conv.id === currentConversationId ? 'active' : ''
              }`}
              onClick={() => setCurrentConversationId(conv.id)}
            >
              {conv.title}
            </div>
          ))}
        </div>
      </div>

      {/* å³ä¾§ï¼šèŠå¤©çª—å£ */}
      <div className="chat-main">
        <div className="messages-container">
          {messages.map((msg) => (
            <div key={msg.id} className={`message ${msg.role}`}>
              <div className="message-content">{msg.content}</div>
            </div>
          ))}
          {loading && <div className="message assistant">æ€è€ƒä¸­...</div>}
        </div>

        <div className="input-container">
          <input
            type="text"
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            disabled={loading}
          />
          <button onClick={handleSend} disabled={loading || !inputText.trim()}>
            å‘é€
          </button>
        </div>
      </div>
    </div>
  );
};

export default ChatPage;
```

**åˆ›å»º `frontend/src/pages/ChatPage.css`**

```css
.chat-container {
  display: flex;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
}

/* å·¦ä¾§è¾¹æ  */
.sidebar {
  width: 250px;
  background-color: #f5f5f5;
  border-right: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
}

.new-chat-btn {
  padding: 12px;
  margin: 10px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.new-chat-btn:hover {
  background-color: #0056b3;
}

.conversation-list {
  flex: 1;
  overflow-y: auto;
}

.conversation-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #e0e0e0;
  transition: background-color 0.2s;
}

.conversation-item:hover {
  background-color: #e8e8e8;
}

.conversation-item.active {
  background-color: #d0e8ff;
  font-weight: bold;
}

/* ä¸»èŠå¤©åŒºåŸŸ */
.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background-color: white;
}

.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.message {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 12px;
  word-wrap: break-word;
}

.message.user {
  align-self: flex-end;
  background-color: #007bff;
  color: white;
}

.message.assistant {
  align-self: flex-start;
  background-color: #f0f0f0;
  color: #333;
}

.message-content {
  white-space: pre-wrap;
}

/* è¾“å…¥åŒºåŸŸ */
.input-container {
  display: flex;
  padding: 16px;
  border-top: 1px solid #e0e0e0;
  gap: 12px;
}

.input-container input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.input-container input:focus {
  outline: none;
  border-color: #007bff;
}

.input-container button {
  padding: 12px 24px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.input-container button:hover:not(:disabled) {
  background-color: #0056b3;
}

.input-container button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}
```

#### æ­¥éª¤ 2.5ï¼šä¿®æ”¹ App.tsx

**ä¿®æ”¹ `frontend/src/App.tsx`**

```typescript
import ChatPage from './pages/ChatPage';
import './App.css';

function App() {
  return <ChatPage />;
}

export default App;
```

#### æ­¥éª¤ 2.6ï¼šå¯åŠ¨å‰ç«¯

```bash
cd frontend
npm run dev
```

è®¿é—® `http://localhost:5173`ï¼ˆVite é»˜è®¤ç«¯å£ï¼‰

---

### é˜¶æ®µ 3ï¼šSSE æµå¼è¾“å‡º

**ç›®æ ‡**ï¼šå®ç°æµå¼å“åº”ï¼Œè®© AI å›ç­”ä¸€ä¸ªå­—ä¸€ä¸ªå­—åœ°æ˜¾ç¤º

**æ—¶é—´ä¼°ç®—**ï¼š2-3 å¤©

#### æ­¥éª¤ 3.1ï¼šä¿®æ”¹åç«¯ Controllerï¼Œæ·»åŠ  SSE æ¥å£

**åœ¨ `ChatController.java` ä¸­æ·»åŠ **ï¼š

```java
import org.springframework.http.MediaType;
import org.springframework.http.codec.ServerSentEvent;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import java.time.Duration;

@RestController
@RequestMapping("/api/chat")
public class ChatController {
    
    // ... ç°æœ‰ä»£ç  ...

    /**
     * SSE æµå¼å¯¹è¯æ¥å£
     * GET /api/chat/conversations/{id}/stream?message=ç”¨æˆ·æ¶ˆæ¯
     */
    @GetMapping(value = "/conversations/{id}/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<ServerSentEvent<String>> streamChat(
            @PathVariable Long id,
            @RequestParam String message) {
        
        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        chatService.addMessage(id, "user", message);
        
        // è°ƒç”¨ AI æµå¼ç”Ÿæˆï¼ˆéœ€è¦å®ç°æµå¼ç‰ˆæœ¬çš„ AiServiceï¼‰
        return chatService.streamAiResponse(id, message)
                .map(content -> ServerSentEvent.<String>builder()
                        .data(content)
                        .build())
                .concatWith(Flux.just(ServerSentEvent.<String>builder()
                        .data("[DONE]")  // æµç»“æŸæ ‡è®°
                        .build()));
    }
}
```

#### æ­¥éª¤ 3.2ï¼šå®ç°æµå¼ AI Service

**ä¿®æ”¹ `AiService.java`ï¼Œæ·»åŠ æµå¼æ–¹æ³•**ï¼š

```java
package com.example.demo.service;

import reactor.core.publisher.Flux;

public interface AiService {
    
    String generateResponse(String userMessage, String conversationHistory);
    
    // æ–°å¢ï¼šæµå¼ç”Ÿæˆ
    Flux<String> streamResponse(String userMessage, String conversationHistory);
}
```

**ä¿®æ”¹ `AiServiceImpl.java`**ï¼š

```java
package com.example.demo.service.impl;

import com.example.demo.service.AiService;
import org.springframework.ai.chat.ChatClient;
import org.springframework.ai.chat.ChatResponse;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;

@Service
public class AiServiceImpl implements AiService {

    private final ChatClient chatClient;

    public AiServiceImpl(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @Override
    public String generateResponse(String userMessage, String conversationHistory) {
        // ... ç°æœ‰ä»£ç  ...
    }

    @Override
    public Flux<String> streamResponse(String userMessage, String conversationHistory) {
        StringBuilder promptBuilder = new StringBuilder();
        
        if (conversationHistory != null && !conversationHistory.isEmpty()) {
            promptBuilder.append("ä»¥ä¸‹æ˜¯å¯¹è¯å†å²ï¼š\n").append(conversationHistory).append("\n\n");
        }
        
        promptBuilder.append("è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š\n").append(userMessage);
        
        Prompt prompt = new Prompt(new UserMessage(promptBuilder.toString()));
        
        // è°ƒç”¨æµå¼ API
        return chatClient.stream(prompt)
                .map(response -> {
                    if (response.getResult() != null && response.getResult().getOutput() != null) {
                        return response.getResult().getOutput().getContent();
                    }
                    return "";
                })
                .filter(content -> !content.isEmpty());
    }
}
```

#### æ­¥éª¤ 3.3ï¼šä¿®æ”¹ ChatServiceï¼Œæ·»åŠ æµå¼æ–¹æ³•

**åœ¨ `ChatService.java` ä¸­æ·»åŠ **ï¼š

```java
import reactor.core.publisher.Flux;

public interface ChatService {
    // ... ç°æœ‰æ–¹æ³• ...
    
    Flux<String> streamAiResponse(Long conversationId, String userMessage);
}
```

**åœ¨ `ChatServiceImpl.java` ä¸­å®ç°**ï¼š

```java
@Override
@Transactional
public Flux<String> streamAiResponse(Long conversationId, String userMessage) {
    // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    Conversation conversation = conversationRepository.findById(conversationId)
            .orElseThrow(() -> new IllegalArgumentException("ä¼šè¯ä¸å­˜åœ¨" + conversationId));
    
    Message userMsg = new Message();
    userMsg.setConversation(conversation);
    userMsg.setRole("user");
    userMsg.setContent(userMessage);
    messageRepository.save(userMsg);
    
    // è·å–å†å²æ¶ˆæ¯
    List<Message> historyMessages = messageRepository
            .findByConversationIdOrderByCreatedAtAsc(conversationId);
    
    String historyText = historyMessages.stream()
            .limit(10)
            .map(msg -> msg.getRole() + ": " + msg.getContent())
            .collect(Collectors.joining("\n"));
    
    // è°ƒç”¨æµå¼ AI
    StringBuilder fullResponse = new StringBuilder();
    
    return aiService.streamResponse(userMessage, historyText)
            .doOnNext(chunk -> fullResponse.append(chunk))
            .doOnComplete(() -> {
                // æµç»“æŸåä¿å­˜å®Œæ•´çš„ AI å›ç­”
                Message assistantMsg = new Message();
                assistantMsg.setConversation(conversation);
                assistantMsg.setRole("assistant");
                assistantMsg.setContent(fullResponse.toString());
                messageRepository.save(assistantMsg);
            });
}
```

#### æ­¥éª¤ 3.4ï¼šä¿®æ”¹å‰ç«¯ï¼Œæ”¯æŒ SSE

**ä¿®æ”¹ `frontend/src/services/api.ts`**ï¼š

```typescript
// æµå¼å‘é€æ¶ˆæ¯
export const streamMessage = async (
  conversationId: number,
  message: string,
  onChunk: (chunk: string) => void,
  onComplete: () => void
) => {
  const eventSource = new EventSource(
    `http://localhost:8080/api/chat/conversations/${conversationId}/stream?message=${encodeURIComponent(message)}`
  );

  eventSource.onmessage = (event) => {
    if (event.data === '[DONE]') {
      eventSource.close();
      onComplete();
    } else {
      onChunk(event.data);
    }
  };

  eventSource.onerror = () => {
    eventSource.close();
    onComplete();
  };
};
```

**ä¿®æ”¹ `ChatPage.tsx`ï¼Œä½¿ç”¨æµå¼æ¥æ”¶**ï¼š

```typescript
const handleSend = async () => {
  if (!inputText.trim() || !currentConversationId || loading) return;

  const userMessage = inputText.trim();
  setInputText('');
  setLoading(true);

  // å…ˆæ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
  const tempUserMessage: Message = {
    id: Date.now(), // ä¸´æ—¶ ID
    role: 'user',
    content: userMessage,
    createdAt: new Date().toISOString(),
  };
  setMessages([...messages, tempUserMessage]);

  // æ·»åŠ ä¸€ä¸ªç©ºçš„ assistant æ¶ˆæ¯ï¼Œç”¨äºæ¥æ”¶æµå¼æ•°æ®
  let assistantMessageId = Date.now() + 1;
  const tempAssistantMessage: Message = {
    id: assistantMessageId,
    role: 'assistant',
    content: '',
    createdAt: new Date().toISOString(),
  };
  setMessages((prev) => [...prev, tempAssistantMessage]);

  try {
    let fullContent = '';
    
    await streamMessage(
      currentConversationId,
      userMessage,
      (chunk) => {
        // æ¥æ”¶æ¯ä¸ªæ•°æ®å—ï¼Œæ›´æ–°æ¶ˆæ¯å†…å®¹
        fullContent += chunk;
        setMessages((prev) =>
          prev.map((msg) =>
            msg.id === assistantMessageId
              ? { ...msg, content: fullContent }
              : msg
          )
        );
      },
      () => {
        // æµç»“æŸï¼Œé‡æ–°åŠ è½½å®Œæ•´æ¶ˆæ¯åˆ—è¡¨
        chatApi.getMessages(currentConversationId!).then((res) => {
          if (res.code === 200) {
            setMessages(res.data);
          }
        });
        setLoading(false);
      }
    );
  } catch (error) {
    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    alert('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
    setLoading(false);
  }
};
```

---

### é˜¶æ®µ 4ï¼šRAG + å‘é‡æ•°æ®åº“

**ç›®æ ‡**ï¼šå®ç°çŸ¥è¯†åº“æ£€ç´¢ï¼Œè®© AI èƒ½å¤ŸåŸºäºæ–‡æ¡£å›ç­”é—®é¢˜

**æ—¶é—´ä¼°ç®—**ï¼š5-7 å¤©

#### æ­¥éª¤ 4.1ï¼šæ·»åŠ å‘é‡æ•°æ®åº“ä¾èµ–ï¼ˆPostgreSQL + pgvectorï¼‰

**ä¿®æ”¹ `pom.xml`**ï¼ˆå¦‚æœä½¿ç”¨ PostgreSQL + pgvectorï¼‰ï¼š

```xml
<!-- pgvector éœ€è¦æ‰‹åŠ¨å®‰è£…æ‰©å±•ï¼Œè¿™é‡Œåªæ˜¯æ·»åŠ ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ Java å®¢æˆ·ç«¯ï¼‰ -->
<!-- å®é™…ä¸Š pgvector æ˜¯ PostgreSQL çš„æ‰©å±•ï¼Œä¸éœ€è¦é¢å¤–çš„ Java ä¾èµ– -->
```

**å®‰è£… pgvector æ‰©å±•**ï¼ˆåœ¨ PostgreSQL ä¸­æ‰§è¡Œï¼‰ï¼š

```sql
-- è¿›å…¥ PostgreSQL å®¹å™¨
docker exec -it pg-ai psql -U postgres -d ai_chat

-- å®‰è£… pgvector æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;
```

#### æ­¥éª¤ 4.2ï¼šåˆ›å»ºæ–‡æ¡£è¡¨

**åˆ›å»º `DocumentChunk` å®ä½“**

```java
package com.example.demo.domain;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Table(name = "document_chunk")
@Data
@NoArgsConstructor
public class DocumentChunk {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "doc_id")
    private Long docId;  // æ–‡æ¡£ IDï¼ˆå¯ä»¥ç”¨æ¥å…³è”å¤šä¸ª chunk å±äºåŒä¸€ä¸ªæ–‡æ¡£ï¼‰

    @Column(columnDefinition = "text", nullable = false)
    private String content;  // æ–‡æ¡£å†…å®¹

    @Column(columnDefinition = "vector(1536)", nullable = false)  // 1536 æ˜¯ OpenAI embedding çš„ç»´åº¦
    private String embedding;  // å‘é‡ï¼ˆPostgreSQL çš„ vector ç±»å‹ï¼‰

    @Column(name = "created_at")
    private java.time.LocalDateTime createdAt = java.time.LocalDateTime.now();
}
```

**åˆ›å»º Repository**ï¼š

```java
package com.example.demo.repository;

import com.example.demo.domain.DocumentChunk;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface DocumentChunkRepository extends JpaRepository<DocumentChunk, Long> {

    // ä½¿ç”¨ pgvector çš„ç›¸ä¼¼åº¦æŸ¥è¯¢
    @Query(value = "SELECT * FROM document_chunk " +
                   "ORDER BY embedding <-> CAST(:queryEmbedding AS vector) " +
                   "LIMIT :limit", nativeQuery = true)
    List<DocumentChunk> findSimilarChunks(@Param("queryEmbedding") String queryEmbedding, 
                                          @Param("limit") int limit);
}
```

#### æ­¥éª¤ 4.3ï¼šå®ç° Embedding Service

**åˆ›å»º `EmbeddingService.java`**ï¼š

```java
package com.example.demo.service;

import java.util.List;

public interface EmbeddingService {
    
    /**
     * å¯¹æ–‡æœ¬ç”Ÿæˆ embedding å‘é‡
     */
    float[] embedText(String text);
    
    /**
     * æ‰¹é‡ç”Ÿæˆ embedding
     */
    List<float[]> embedTexts(List<String> texts);
    
    /**
     * å°† float[] è½¬æ¢ä¸º PostgreSQL vector æ ¼å¼çš„å­—ç¬¦ä¸²
     */
    String toVectorString(float[] embedding);
}
```

**å®ç° `EmbeddingServiceImpl.java`**ï¼š

```java
package com.example.demo.service.impl;

import com.example.demo.service.EmbeddingService;
import org.springframework.ai.embedding.EmbeddingClient;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
public class EmbeddingServiceImpl implements EmbeddingService {

    private final EmbeddingClient embeddingClient;

    public EmbeddingServiceImpl(EmbeddingClient embeddingClient) {
        this.embeddingClient = embeddingClient;
    }

    @Override
    public float[] embedText(String text) {
        List<Double> embedding = embeddingClient.embed(text);
        return embedding.stream()
                .mapToDouble(Double::doubleValue)
                .collect(() -> new float[embedding.size()],
                        (array, value) -> array[0] = value.floatValue(),
                        (a, b) -> {});
    }

    @Override
    public List<float[]> embedTexts(List<String> texts) {
        List<List<Double>> embeddings = embeddingClient.embed(texts);
        List<float[]> result = new ArrayList<>();
        for (List<Double> embedding : embeddings) {
            float[] array = embedding.stream()
                    .mapToDouble(Double::doubleValue)
                    .collect(() -> new float[embedding.size()],
                            (arr, val) -> arr[0] = val.floatValue(),
                            (a, b) -> {});
            result.add(array);
        }
        return result;
    }

    @Override
    public String toVectorString(float[] embedding) {
        StringBuilder sb = new StringBuilder("[");
        for (int i = 0; i < embedding.length; i++) {
            if (i > 0) sb.append(",");
            sb.append(embedding[i]);
        }
        sb.append("]");
        return sb.toString();
    }
}
```

#### æ­¥éª¤ 4.4ï¼šå®ç° RAG Service

**åˆ›å»º `RagService.java`**ï¼š

```java
package com.example.demo.service;

import java.util.List;

public interface RagService {
    
    /**
     * æ–‡æ¡£å…¥åº“ï¼ˆåˆ‡åˆ† + embedding + å­˜å‚¨ï¼‰
     */
    void ingestDocument(String documentContent, Long docId);
    
    /**
     * RAG æ£€ç´¢ï¼šæ ¹æ®é—®é¢˜æ‰¾åˆ°ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
     */
    List<String> retrieveRelevantChunks(String query, int topK);
    
    /**
     * ä½¿ç”¨ RAG ç”Ÿæˆå›ç­”
     */
    String generateRagResponse(String query, List<String> relevantChunks);
}
```

**å®ç° `RagServiceImpl.java`**ï¼š

```java
package com.example.demo.service.impl;

import com.example.demo.domain.DocumentChunk;
import com.example.demo.repository.DocumentChunkRepository;
import com.example.demo.service.AiService;
import com.example.demo.service.EmbeddingService;
import com.example.demo.service.RagService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class RagServiceImpl implements RagService {

    private final EmbeddingService embeddingService;
    private final DocumentChunkRepository documentChunkRepository;
    private final AiService aiService;

    public RagServiceImpl(EmbeddingService embeddingService,
                          DocumentChunkRepository documentChunkRepository,
                          AiService aiService) {
        this.embeddingService = embeddingService;
        this.documentChunkRepository = documentChunkRepository;
        this.aiService = aiService;
    }

    @Override
    @Transactional
    public void ingestDocument(String documentContent, Long docId) {
        // 1. æ–‡æœ¬åˆ‡åˆ†ï¼ˆç®€å•æŒ‰æ®µè½åˆ‡åˆ†ï¼Œå¯ä»¥ä¼˜åŒ–ä¸ºæŒ‰è¯­ä¹‰åˆ‡åˆ†ï¼‰
        List<String> chunks = splitText(documentContent, 500);  // æ¯ 500 å­—ä¸€æ®µ

        // 2. æ‰¹é‡ç”Ÿæˆ embedding
        List<float[]> embeddings = embeddingService.embedTexts(chunks);

        // 3. ä¿å­˜åˆ°æ•°æ®åº“
        for (int i = 0; i < chunks.size(); i++) {
            DocumentChunk chunk = new DocumentChunk();
            chunk.setDocId(docId);
            chunk.setContent(chunks.get(i));
            chunk.setEmbedding(embeddingService.toVectorString(embeddings.get(i)));
            documentChunkRepository.save(chunk);
        }
    }

    @Override
    public List<String> retrieveRelevantChunks(String query, int topK) {
        // 1. å¯¹æŸ¥è¯¢é—®é¢˜ç”Ÿæˆ embedding
        float[] queryEmbedding = embeddingService.embedText(query);
        String queryVector = embeddingService.toVectorString(queryEmbedding);

        // 2. å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
        List<DocumentChunk> chunks = documentChunkRepository
                .findSimilarChunks(queryVector, topK);

        // 3. è¿”å›å†…å®¹
        return chunks.stream()
                .map(DocumentChunk::getContent)
                .collect(Collectors.toList());
    }

    @Override
    public String generateRagResponse(String query, List<String> relevantChunks) {
        // æ„å»º Promptï¼ŒåŒ…å«æ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µ
        StringBuilder context = new StringBuilder();
        context.append("ä»¥ä¸‹æ˜¯ä¸é—®é¢˜ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µï¼š\n\n");
        for (int i = 0; i < relevantChunks.size(); i++) {
            context.append("ç‰‡æ®µ ").append(i + 1).append(":\n");
            context.append(relevantChunks.get(i)).append("\n\n");
        }
        context.append("è¯·åŸºäºä»¥ä¸Šæ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜ï¼š").append(query);

        // è°ƒç”¨ AI ç”Ÿæˆå›ç­”
        return aiService.generateResponse(query, context.toString());
    }

    // ç®€å•çš„æ–‡æœ¬åˆ‡åˆ†æ–¹æ³•
    private List<String> splitText(String text, int chunkSize) {
        List<String> chunks = new ArrayList<>();
        int length = text.length();
        for (int i = 0; i < length; i += chunkSize) {
            int end = Math.min(i + chunkSize, length);
            chunks.add(text.substring(i, end));
        }
        return chunks;
    }
}
```

#### æ­¥éª¤ 4.5ï¼šä¿®æ”¹ ChatControllerï¼Œæ·»åŠ  RAG æ¥å£

```java
@RestController
@RequestMapping("/api/chat")
public class ChatController {
    
    private final ChatService chatService;
    private final RagService ragService;  // æ–°å¢

    public ChatController(ChatService chatService, RagService ragService) {
        this.chatService = chatService;
        this.ragService = ragService;
    }

    // ... ç°æœ‰æ–¹æ³• ...

    /**
     * RAG å¯¹è¯æ¥å£ï¼ˆå¸¦çŸ¥è¯†åº“æ£€ç´¢ï¼‰
     * POST /api/chat/conversations/{id}/rag
     */
    @PostMapping("/conversations/{id}/rag")
    public Result<Message> ragChat(
            @PathVariable Long id,
            @RequestBody Map<String, String> request) {
        String content = request.getOrDefault("content", "");
        
        // 1. æ£€ç´¢ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
        List<String> relevantChunks = ragService.retrieveRelevantChunks(content, 5);
        
        // 2. ä½¿ç”¨ RAG ç”Ÿæˆå›ç­”
        String aiResponse = ragService.generateRagResponse(content, relevantChunks);
        
        // 3. ä¿å­˜æ¶ˆæ¯
        chatService.addMessage(id, "user", content);
        Message assistantMsg = chatService.addMessage(id, "assistant", aiResponse);
        
        return Result.success(assistantMsg);
    }

    /**
     * æ–‡æ¡£å…¥åº“æ¥å£
     * POST /api/rag/ingest
     */
    @PostMapping("/rag/ingest")
    public Result<String> ingestDocument(@RequestBody Map<String, Object> request) {
        String content = (String) request.get("content");
        Long docId = request.containsKey("docId") ? 
            Long.valueOf(request.get("docId").toString()) : null;
        
        if (content == null || content.isEmpty()) {
            return Result.error("æ–‡æ¡£å†…å®¹ä¸èƒ½ä¸ºç©º");
        }
        
        ragService.ingestDocument(content, docId);
        return Result.success("æ–‡æ¡£å…¥åº“æˆåŠŸ");
    }
}
```

---

### é˜¶æ®µ 5ï¼šAgent / FunctionCallï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**ï¼šå®ç°å·¥å…·è°ƒç”¨ï¼Œè®© AI èƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨å‡½æ•°

**æ—¶é—´ä¼°ç®—**ï¼š3-5 å¤©

#### æ­¥éª¤ 5.1ï¼šå®šä¹‰å·¥å…·æ¥å£

**åˆ›å»º `Tool.java`**ï¼š

```java
package com.example.demo.service.tool;

public interface Tool {
    String getName();
    String getDescription();
    String execute(String input);
}
```

**åˆ›å»ºç¤ºä¾‹å·¥å…·**ï¼š

```java
package com.example.demo.service.tool.impl;

import com.example.demo.service.tool.Tool;
import org.springframework.stereotype.Component;

@Component
public class WeatherTool implements Tool {
    @Override
    public String getName() {
        return "get_weather";
    }

    @Override
    public String getDescription() {
        return "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ã€‚è¾“å…¥æ ¼å¼ï¼šåŸå¸‚åç§°";
    }

    @Override
    public String execute(String input) {
        // æ¨¡æ‹Ÿå¤©æ°”æŸ¥è¯¢ï¼ˆå®é™…åº”è¯¥è°ƒç”¨çœŸå®çš„å¤©æ°” APIï¼‰
        return String.format("%s çš„å¤©æ°”ï¼šæ™´å¤©ï¼Œæ¸©åº¦ 25Â°C", input);
    }
}
```

#### æ­¥éª¤ 5.2ï¼šå®ç°ç®€å•çš„ Agent

**åˆ›å»º `AgentService.java`**ï¼š

```java
package com.example.demo.service;

public interface AgentService {
    String processWithTools(String userMessage);
}
```

**å®ç° `AgentServiceImpl.java`**ï¼š

```java
package com.example.demo.service.impl;

import com.example.demo.service.AgentService;
import com.example.demo.service.AiService;
import com.example.demo.service.tool.Tool;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
public class AgentServiceImpl implements AgentService {

    private final AiService aiService;
    private final List<Tool> tools;  // æ³¨å…¥æ‰€æœ‰å·¥å…·

    public AgentServiceImpl(AiService aiService, List<Tool> tools) {
        this.aiService = aiService;
        this.tools = tools;
    }

    @Override
    public String processWithTools(String userMessage) {
        // 1. å…ˆè®© AI åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·
        String toolPrompt = buildToolPrompt(userMessage);
        String aiDecision = aiService.generateResponse(toolPrompt, null);
        
        // 2. è§£æ AI çš„å†³ç­–ï¼ˆç®€å•ç‰ˆæœ¬ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨ï¼‰
        Tool tool = findToolToUse(aiDecision, userMessage);
        
        if (tool != null) {
            // 3. è°ƒç”¨å·¥å…·
            String toolResult = tool.execute(extractToolInput(userMessage));
            
            // 4. æŠŠå·¥å…·ç»“æœä¼ ç»™ AIï¼Œç”Ÿæˆæœ€ç»ˆå›ç­”
            String finalPrompt = String.format(
                "ç”¨æˆ·é—®é¢˜ï¼š%s\nå·¥å…·æ‰§è¡Œç»“æœï¼š%s\nè¯·åŸºäºå·¥å…·ç»“æœå›ç­”ç”¨æˆ·é—®é¢˜ã€‚",
                userMessage, toolResult
            );
            return aiService.generateResponse(finalPrompt, null);
        } else {
            // ä¸éœ€è¦å·¥å…·ï¼Œç›´æ¥å›ç­”
            return aiService.generateResponse(userMessage, null);
        }
    }

    private String buildToolPrompt(String userMessage) {
        StringBuilder prompt = new StringBuilder();
        prompt.append("ç”¨æˆ·é—®é¢˜ï¼š").append(userMessage).append("\n\n");
        prompt.append("å¯ç”¨å·¥å…·ï¼š\n");
        for (Tool tool : tools) {
            prompt.append("- ").append(tool.getName())
                  .append(": ").append(tool.getDescription()).append("\n");
        }
        prompt.append("\nè¯·åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ã€‚å¦‚æœéœ€è¦ï¼Œå›å¤å·¥å…·åç§°ï¼›å¦‚æœä¸éœ€è¦ï¼Œå›å¤ 'none'ã€‚");
        return prompt.toString();
    }

    private Tool findToolToUse(String aiDecision, String userMessage) {
        // ç®€å•åŒ¹é…ï¼šæ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«å…³é”®è¯
        if (userMessage.contains("å¤©æ°”")) {
            return tools.stream()
                    .filter(t -> t.getName().equals("get_weather"))
                    .findFirst()
                    .orElse(null);
        }
        return null;
    }

    private String extractToolInput(String userMessage) {
        // ç®€å•æå–ï¼šæå–åŸå¸‚åç§°
        Pattern pattern = Pattern.compile("(.+?)çš„å¤©æ°”");
        Matcher matcher = pattern.matcher(userMessage);
        if (matcher.find()) {
            return matcher.group(1);
        }
        return userMessage;
    }
}
```

---

## ğŸ—‚ï¸ é¡¹ç›®æœ€ç»ˆç›®å½•ç»“æ„

```
test_easyJava/
â”œâ”€â”€ backend/                          # åç«¯ï¼ˆSpring Bootï¼‰
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ main/
â”‚           â”œâ”€â”€ java/
â”‚           â”‚   â””â”€â”€ com/example/demo/
â”‚           â”‚       â”œâ”€â”€ common/       # é€šç”¨ç±»
â”‚           â”‚       â”‚   â”œâ”€â”€ Dto/      # Result ç­‰
â”‚           â”‚       â”‚   â””â”€â”€ exception/ # å¼‚å¸¸å¤„ç†
â”‚           â”‚       â”œâ”€â”€ controller/   # æ§åˆ¶å™¨
â”‚           â”‚       â”œâ”€â”€ domain/       # å®ä½“ç±»
â”‚           â”‚       â”œâ”€â”€ repository/   # æ•°æ®è®¿é—®
â”‚           â”‚       â”œâ”€â”€ service/      # æœåŠ¡æ¥å£
â”‚           â”‚       â”‚   â””â”€â”€ impl/     # æœåŠ¡å®ç°
â”‚           â”‚       â”‚       â””â”€â”€ tool/ # å·¥å…·ç±»ï¼ˆAgent ç”¨ï¼‰
â”‚           â”‚       â””â”€â”€ TestEasyJavaApplication.java
â”‚           â””â”€â”€ resources/
â”‚               â””â”€â”€ application.yml
â”œâ”€â”€ frontend/                         # å‰ç«¯ï¼ˆReactï¼‰
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/               # ç»„ä»¶
â”‚       â”œâ”€â”€ pages/                    # é¡µé¢
â”‚       â”œâ”€â”€ services/                 # API è°ƒç”¨
â”‚       â”œâ”€â”€ App.tsx
â”‚       â””â”€â”€ main.tsx
â”œâ”€â”€ docs/                             # æ–‡æ¡£
â”‚   â”œâ”€â”€ é…ç½®.md
â”‚   â””â”€â”€ åç»­å¼€å‘è®¡åˆ’.md
â””â”€â”€ pom.xml
```

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. API Key ç®¡ç†
- ä¸è¦å°† API Key æäº¤åˆ° Git
- ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ï¼ˆä¸æäº¤ï¼‰
- åœ¨ `application.yml` ä¸­ä½¿ç”¨ `${ENV_VAR}` è¯»å–

### 2. é”™è¯¯å¤„ç†
- æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†å™¨
- ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- è®°å½•é”™è¯¯æ—¥å¿—

### 3. æ€§èƒ½ä¼˜åŒ–
- RAG æ£€ç´¢æ—¶é™åˆ¶è¿”å›æ•°é‡ï¼ˆtopKï¼‰
- æµå¼è¾“å‡ºæ—¶æ§åˆ¶ buffer å¤§å°
- æ•°æ®åº“æŸ¥è¯¢æ·»åŠ ç´¢å¼•

### 4. æµ‹è¯•
- åç«¯æ¥å£ç”¨ Postman æµ‹è¯•
- å‰ç«¯åŠŸèƒ½åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•
- å…³é”®åŠŸèƒ½å†™å•å…ƒæµ‹è¯•

---

## ğŸ¯ é‡Œç¨‹ç¢‘æ£€æŸ¥ç‚¹

- [ ] **é‡Œç¨‹ç¢‘ 1**ï¼šSpring AI é›†æˆå®Œæˆï¼Œèƒ½å¤Ÿè°ƒç”¨å¤§æ¨¡å‹
- [ ] **é‡Œç¨‹ç¢‘ 2**ï¼šå‰ç«¯ç•Œé¢å®Œæˆï¼Œèƒ½å¤Ÿå‘é€æ¶ˆæ¯å¹¶æ˜¾ç¤ºå›ç­”
- [ ] **é‡Œç¨‹ç¢‘ 3**ï¼šSSE æµå¼è¾“å‡ºå®Œæˆï¼Œå›ç­”é€å­—æ˜¾ç¤º
- [ ] **é‡Œç¨‹ç¢‘ 4**ï¼šRAG åŠŸèƒ½å®Œæˆï¼Œèƒ½å¤ŸåŸºäºæ–‡æ¡£å›ç­”
- [ ] **é‡Œç¨‹ç¢‘ 5**ï¼šAgent/FunctionCall å®Œæˆï¼ˆå¯é€‰ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

- Spring AI å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-ai/reference/
- pgvector æ–‡æ¡£ï¼šhttps://github.com/pgvector/pgvector
- React å®˜æ–¹æ–‡æ¡£ï¼šhttps://react.dev/
- WebFlux SSE æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-framework/reference/web/webflux/controller/ann-methods/sse.html

---

**ç¥å¼€å‘é¡ºåˆ©ï¼ğŸš€**

